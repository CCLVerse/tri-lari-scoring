---
title: "TRI/LARI Analyses"
author: "Sirish Shrestha"
date: "2023-11-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("./src/init.R")

```

The ordering of the raters is important to generate consistent `lavaan` results. Based on the ordering of the raters, the calculations may be different.


```{r configure-cols, echo=FALSE}

## all competency columns from the database
load_variables <- function(data=NULL, factor_name="decisive"){
  competency_cols <- get_column_names(df=data, pattern = COMPETENCY_COL_PATTERN)
  
  ## all item columns that make up the competency columns
  competency_item_cols <- get_column_names(df=data, pattern = ITEM_COL_PATTERN)
  
  research_cols <- get_column_names(df=data, pattern = RESEARCH_COL_PATTERN)
  
  required_cols <- c("ESI_Key", "RaterType")
  
  grouping_cols <- c("ESI_Key", "RaterType")
  
  ## also in ./src/globals.r
  raters <- c("Self", "Direct Report", "Peer", "Boss")
  
  factor_name <- factor_name
}
```



```{r data-processing, echo=FALSE}

#' Render Data Processing R Markdown Document
#'
#' This function renders a data processing R Markdown document, processing
#' the provided data and generating an HTML output file.
#'
#' @param data A data frame containing the input data for processing.
#' @param sample_name A character string specifying the sample name (default is "Normative").
#'
#' @details The function renders the R Markdown document located at "./src/01_bmk_data_processing.Rmd"
#' and saves the HTML output file in the "./output" directory. It passes various parameters to the
#' R Markdown document for customization.
#'
#' @param raters A vector specifying the column names representing raters in the input data.
#' @param grouping_cols A vector specifying the column names used for grouping in the data processing.
#' @param required_cols A vector specifying the column names required for data processing.
#' @param competency_item_cols A vector specifying the column names representing competency items in the data.
#' @param competency_cols A vector specifying the column names representing competency scores in the data.
#' @param research_cols A vector specifying the column names representing research-related information in the data.
#'
#' @seealso [rmarkdown::render()]
#'
#' @return The function renders the R Markdown document and does not return any value.
#'
#' @examples
#' \dontrun{
#' # Example usage
#' data <- read.csv("your_data.csv")
#' render_data_processing(data, sample_name = "Normative")
#' }
#'

render_data_processing <- function(data, sample_name="Normative"){
  
  output_filename <- sprintf("%s_data_processing", tolower(sample_name))

  ## process data
  rmarkdown::render(input = "./src/01_bmk_data_processing.Rmd", 
                    output_dir = "./output",
                    output_format = "html", 
                    output_file = output_filename,
                    params = list(
                        data = data, 
                        raters = raters, 
                        grouping_cols = grouping_cols,
                        required_cols = required_cols, 
                        competency_item_cols = competency_item_cols,
                        competency_cols = competency_cols,
                        research_cols = research_cols
                      )
                    )

}

```


## Run Lavaan Analyses (Decisiveness)

```{r lavaan, echo=FALSE}

#' Render Lavaan Analyses R Markdown Document
#'
#' This function renders a lavaan analyses R Markdown document, generating an HTML output file
#' with specified parameters for analysis and presentation.
#'
#' @param factor_name A character string specifying the factor name for the analyses (default is "decisive").
#' @param sample_name A character string specifying the sample name for the analyses (default is "Normative").
#' @param show_model A logical value indicating whether to include the lavaan model in the output (default is TRUE).
#' @param column_pattern_for_analyses A character string specifying a pattern for columns to include in the analyses (default is an empty string).
#' @param competency_cols A character string specifying a regular expression pattern for competency columns in the data.
#' @param competency_cols_with_factor_weights A character string specifying a regular expression pattern for competency columns with factor weights.
#' @param columns_to_remove_missing_values A character string specifying a regular expression pattern for columns to remove missing values.
#' @param factor_weights_competency_cols A character string specifying a regular expression pattern for factor weights related to competency columns.
#' @param factor_weights_cols A character string specifying a regular expression pattern for factor weights columns.
#' @param outcome_raters A character string specifying a regular expression pattern for outcome raters.
#' @param outcome_colname A character string specifying the column name for outcome measures.
#'
#' @details The function renders the R Markdown document located at "./src/02_bmk_lavaan_analyses.Rmd"
#' and saves the HTML output file in the "./output" directory. It passes various parameters to the
#' R Markdown document for customization.
#'
#' @seealso [rmarkdown::render()]
#'
#' @return The function renders the R Markdown document and does not return any value.
#'
#' @examples
#' \dontrun{
#' # Example usage
#' render_lavaan_analyses(factor_name = "factor1", sample_name = "CustomSample", show_model = TRUE)
#' }
#'
render_lavaan_analyses <- function(factor_name="decisive", 
                                   sample_name="Normative", 
                                   show_model=TRUE,
                                   column_pattern_for_analyses="",
                                   competency_cols="BMK_S1_34|BMK_S1_73|BMK_S1_77",
                                   competency_cols_with_factor_weights="BMK_S1_(34|73|77)(?!.*decisive).*", 
                                   columns_to_remove_missing_values="ESI_Key|BMK_S1_34|BMK_S1_73|BMK_S1_77",
                                   factor_weights_competency_cols="\\w+_S1_(34|73|77)(?!.*decisive).*", 
                                   factor_weights_cols="\\w+_S1_(34|73|77)(.*decisive).",
                                   outcome_raters="BMK_S5_1_mean_(?!Self)",
                                   outcome_colname="BMK_S5_1_mean_all_rater"){

  title <- sprintf("Lavaan TRI<span style='color:gold;'>/</span>LARI Analyses for %s (%s Sample)", 
                   stringi::stri_trans_totitle(factor_name),  
                   stringi::stri_trans_totitle(sample_name))
  
  output_file <- sprintf("%s_lavaan_%s", tolower(sample_name), factor_name)
  
rmarkdown::render(input = "./src/02_bmk_lavaan_analyses.Rmd", 
                  output_dir = "./output", 
                  output_format = "html",
                  output_file = output_file,
                  params = list(
                    title = title,
                    data = avg_scores_by_rater_df,
                    competency_cols = competency_cols,
                    competency_cols_with_factor_weights = competency_cols_with_factor_weights,
                    factor_name = format_name,
                    raters = raters, 
                    regex_pattern = TRUE,
                    sample_name = sample_name,
                    show_model = show_model, 
                    columns_for_analyses = column_pattern_for_analyses,
                    columns_to_remove_missing_values = columns_to_remove_missing_values, 
                    factor_weights_competency_cols = factor_weights_competency_cols, 
                    factor_weights_cols = factor_weights_cols,
                    outcome_raters = outcome_raters,
                    outcome_colname = outcome_colname
                  ))

}

```



## Normative Sample 

```{r main}

# Read the data
BMK2018_A <- readRDS("./data/BMK2018_A.RData")
# BMK2018_B <- readRDS("./data/BMK2018_B.RData")

BMK2018_A$ESI_Key <- factor(BMK2018_A$ESI_Key)
BMK2018_A$RaterType <- factor(BMK2018_A$RaterType, levels = raters)


set_current_df(df=BMK2018_A)

load_variables(data=BMK2018_A, factor_name = 'decisive')

```



```{r}

#1. Decisiveness

## data processing
render_data_processing(data=BMK2018_A, sample_name = "Normative")

column_pattern_for_analyses <- "ESI_Key|BMK_S1_34|BMK_S1_73|BMK_S1_77|BMK_S2_8|BMK_S2_13|BMK_S2_15|BMK_S2_19|BMK_S2_22|BMK_S2_17|BMK_S2_25|BMK_S2_35|BMK_S2_18|BMK_S2_21|BMK_S2_23|BMK_S2_28|BMK_S2_30|BMK_S2_34|BMK_S2_36|BMK_S2_6|BMK_S2_7|BMK_S2_12|BMK_S2_14|BMK_S2_10|BMK_S2_5|BMK_S2_16|BMK_S2_26|BMK_S2_24|BMK_S2_33|BMK_S2_2|BMK_S2_20|BMK_S2_27|BMK_S2_29|BMK_S2_31|BMK_S2_32|BMK_S2_3|BMK_S2_4|BMK_S2_1|BMK_S2_11|BMK_S2_9|BMK_S5_1|BMK_S5_2|BMK_S5_3|BMK_S5_4|BMK_S5_5|BMK_S5_6|BMK_S5_7|BMK_S5_8|BMK_S5_9"

factor_name <- "decisive" 
sample_name <- "Normative" 
show_model <- TRUE
column_pattern_for_analyses <- ""
competency_cols <- "BMK_S1_34|BMK_S1_73|BMK_S1_77"
competency_cols_with_factor_weights <- "BMK_S1_(34|73|77)(?!.*decisive).*" 
columns_to_remove_missing_values <- "ESI_Key|BMK_S1_34|BMK_S1_73|BMK_S1_77"
factor_weights_competency_cols <- "\\w+_S1_(34|73|77)(?!.*decisive).*" 
factor_weights_cols <- "\\w+_S1_(34|73|77)(.*decisive)."
outcome_raters <- "BMK_S5_1_mean_(?!Self)"
outcome_colname <- "BMK_S5_1_mean_all_rater"

render_lavaan_analyses(factor_name=factor_name,
                        sample_name=sample_name,
                        show_model=show_model,
                        column_pattern_for_analyses=column_pattern_for_analyses,
                        competency_cols=competency_cols,
                        competency_cols_with_factor_weights=competency_cols_with_factor_weights,
                        columns_to_remove_missing_values=columns_to_remove_missing_values,
                        factor_weights_competency_cols=factor_weights_competency_cols,
                        factor_weights_cols=factor_weights_cols,
                        outcome_raters=outcome_raters,
                        outcome_colname=outcome_colname)


```


```{r}

## run for the following: 


# 2. Being a quick study


# 3. Strategic perspective


# 4. Leading employees


# 5. Respect for differences


# 6. Compassion & Sensitivity




```



